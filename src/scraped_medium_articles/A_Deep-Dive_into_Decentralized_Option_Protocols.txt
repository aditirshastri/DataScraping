url: https://polygontech.medium.com/a-game-of-premiums-through-a-myriad-of-complexities-a-deep-dive-into-on-chain-option-protocols-d9619fe99278

Title: A DEEP-DIVE INTO DECENTRALIZED OPTION PROTOCOLS
Medium

INTRODUCTION

A Game of Premiums Through A Myriad of Complexities! — A Deep-Dive into On-Chain Option Protocols
Are Decentralized Derivative Markets the New Meta?
On-chain derivatives are a tough nut to build. From pricing mechanisms to assimilation of collateral in the engine — everything has to be done in a sophisticated manner to ensure liquidity in the system. The work doesn’t end at maintaining liquidity, you have to keep it from getting fragmented. Market sentiments go south, and that fragmented liquidity blows your system out of proportion into an absolute chaos! So what do you do as a protocol? You go ahead and lock it for the time being. But what about your liquidity providers? As an LP or an options writer, your time is running, and your capital keeps accruing an opportunity cost. There’s nowhere to go, your precious collateral is at the risk of those positions being exercised at in-the-money! But wait, this sounds confusing right? So how does one figure out a way through rabbit-hole of on-chain options? Before we move forward, you can connect with me on twitter at 👉 0xlol


ENTERING THE RABBIT HOLE…
To dig into this hole deeper, we have to first make an effort to understand what actually are ‘options’, and are they really worth our time? Option contracts are one of many types of derivatives. So, what’s a derivative? Derivatives are financial instruments, which in the form of contracts derive value from an underlying asset(s). These assets are traded in a free market which makes their price volatile. These derivative contracts provide you with an exposure at a discount for a certain ‘premium’. So if you are contemplating Bitcoin’s price to move in any direction (up/down) from the current price of ~ $47k in near future, you can buy/sell a derivative contract consisting of x Bitcoins at a date in near future for just y % (where y &lt; 100) of their actual (spot) price.
But, why would you do that? Very broadly, derivatives can either be used to amplify your gains or to hedge your risk. As you get to buy/sell the asset at discount with these contracts, you can spend less capital to deal more units. But when we look from a risk point-of-view, holding your wealth in these assets for gains provides you with an exposure to some risk as well. And hence to hedge this risk, you could deal derivatives in an appropriate direction (at the risk of your premium getting liquidating).
The notional value of outstanding derivatives in first half of 2021 was recorded on the upside of $600T while the cryptocurrency derivative market is nowhere near the $1T figure. Though cryptocurrencies lie on the blockchain infrastructure — major volumes of these derivatives are traded off-chain on exchanges like Binance, Deribit, etc.
OTC Derivatives Notional Amount Outstanding by Risk Category. (x-axis = year, y-axis = USD in Trillions) Source: https://www.bis.org/publ/otc_hy2111.htm
With the enormous growth in adoption of cryptocurrencies — the on-chain derivatives market is still at a very nascent stage. Especially when we talk about options. None of the protocols hosting on–chain options currently have a total value locked (TVL) on the upside of $1B. This doesn’t indicate the extent of traction they get, it just means that crafting scalable and stable on-chain options is a tough task.
Before we try to dissect different on-chain option protocols, let’s first understand the dynamics of an option contract. Broadly, options can be of two types — ‘call’ and ‘put’. By paying a premium, call buyers have the ‘right’ to buy assets at a fixed price (strike price) in future and vice versa for put buyers. Option sellers, on the other hand, earn this premium by selling or writing the contract to option buyers. They have the ‘obligation’ to sell the underlying to the option buyer at strike price. This premium can be decided by a number of pricing mechanisms. It should be noted that standard option contracts have an expiration date, based on which they can be exercised in two different ways — either before expiration or at the time of expiration. American-style options are flexible and can be exercised before expiration as well as at the time of expiration, while European-style options, on the other hand, can only be exercised at expiration.
Below we see the standard graph for a ‘long call’. It clearly demonstrates how a ‘long call’ hedges your risk by capping your losses when the asset price keeps depreciating.
Standard Long Call Option Source: investopedia
Now, as we have a little clarity on the structure of an ‘option contract’, lets try to understand their execution on a blockchain infrastructure.
For this research, we went through documents and whitepapers of more than 20 different on-chain option protocols (having complete or partial engine on-chain). As mentioned before, the execution of option contracts on-chain is a tough task. But what exactly makes it difficult? The answer is liquidity. For any financial market to function efficiently, it requires deep liquidity. In its absence, these protocols face sharp fluctuations resulting in chaos.
Knowledge Graph Showcasing Various Interconnected Components in the On-Chain Options Ecosystem
To understand this better, let’s try to understand the collateralization process involved in writing an option. Basically, an option writer puts up a unique amount of collateral in the engine to generate/draft the contract. As the position is unique — it makes it ‘non-fungible’. Hence, not everyone would want to buy that unique non-fungible position — making the ecosystem illiquid and fragmented with big fragments (as there will always be whales with huge positions). So, along with being illiquid, the ecosystem is now prone to risk large positions being exercised.
This problem of fragmented liquidity on the blockchain is being solved by ‘tokenization’ of positions on various ERC standards. A derivative on the top of a derivative! Since the ERC-20 standard provides space for fungibility, it can be seen as a popular choice among various protocols like Opium Network, Ribbon Finance, Opyn, Dopex, etc. Though this approach solves the problem by introducing fungibility — exercising large position sizes can still cause huge disturbance in the liquidity pools.
This problem can be solved by keeping the liquidity locked till expiration, which is the case for European-style options. When we look at the traction (through TVL and volume) — European-style options have been majorly successful, ex. Opyn, Ribbon, Dopex, etc. At the same time, some protocols like Friktion and Premia seem to be performing well with American style. Though they might have performed well with their novel mechanisms to conserve liquidity, their TVL is still less than that of many European-style ones. Below we see how Premia’s TVL reacts strongly to bad market conditions. With this kind of volatility, it becomes hard to maintain a steady state in the protocol.
Total Value Locked in Premia Source: defipulse
On the other hand Hegic, an American-style option protocol tries to deal with the liquidity problem differently. Their hedge contracts distributes gains (premiums) as well as risk (capital loss if positions exercised at ITM) equally among all the LPs. Though this ‘diversification of risk’ might seem to go in its favor, TVL shows otherwise. TVL on Hegic has been in a downtrend since December ’20, and almost dead now.
Derivatives are risky, and are kind of tricky when it comes to capital loss. Most of the option-writers have to take this risk in order to earn the premium. We found that most of the protocols have certain in-built sophisticated mechanisms to avert the risk. Arrow Markets on Avalanche has a comprehensive system to deal with it through a dynamic collateralization mechanism for its insurance pools, whereas protocols like LYRA avert the risk by charging a higher fee to traders who bring a greater amount of liability with them. Base-primitives like Opium Network keep their losses capped through fixed margin mechanisms. While protocols like Opyn hedge any non-linear exposure (Uniswap LP) with a linear instrument (futures) and a quadratic instrument (SQUEETH).
Though all these protocols have dedicated risk-aversion tactics, Dopex has adopted a different approach. Thanks to its clever dual-token tokenomics it compensates the LPs or option writers for their loss using its rebate token ‘rDPX’. Additionally, it captures stable liquidity by rewarding LPs with its governance token ‘DPX’, which comes with other benefits like fee-accrual and discounted option purchases.
It should be noted that despite of all these risk-aversion mechanisms, they still carry some risks, which can be attributed to their architecture. Smart-contract risk being one the major problems here. Most of these protocols have administrator rights with their teams and aren’t decentralized enough. LYRA has been found with significant capital-loss risks in their audit, while Thetanuts has been found mispricing the orders in synthetic mining for certain vaults. In hybrid protocols like DERI, LPs realize profits at the expense of traders. Such vulnerabilities/faults are a big hindrance in mass adoption of option derivatives on the blockchain infrastructure.

LIQUIDITY/COLLATERAL MECHANISMS/RISK AVERSION TO LPS
Since we already discussed the risks associated with the absence of deep and continuous liquidity for on-chain option protocols, let’s take an in-depth view of the mechanisms involved in ensuring an efficient flow of capital/collateral in their systems.
With base primitives like Opium, Katana and Opyn (GAMMA), liquidity is usually dependent on the products/apps made on top of them, but at the same time they have their unique in-built mechanisms. Though derivative recipe may decide the leverage flow in the apps built on Opium, the base-primitive layer allows swaps for existing positions. It discourages minting and burning of new tokens and encourages deeper-liquidity on the applications. Similarly, on Opyn (GAMMA) one can access features such as partial collateralization, wider spreads, and flash-minting of o-tokens to achieve capital-efficiency and deeper liquidity.
GAMMA has a very special feature where vault collateralization is checked only in the end of a transaction. Hence, option positions i.e. o-Tokens can be minted (flash minting) even without putting any collateral as long as they are burned before a transaction is concluded. Even partially collateralized o-Tokens can be generated and sold to buyers for a premium. This premium could then be used to compensate for the remaining collateral.
Flash Minting of o-Tokens on Opyn Gamma
Through partial collateralization one can have greater control over their in-protocol liquidity, whereas through wider-spreads one can create put and call options to enable the collateralization of short o-Tokens (ERC 20) by long o-Tokens (ERC 20). Rysk, a protocol focused on delta-neutral strategies leverages features from Opyn’s Squeeth as well as GAMMA to effectively hedge and manage its collateral.
As we now have an idea about base primitives, let’s look at the collateral mechanisms involved in protocols with native engines for generating option positions. Some of the examples are Arrow Markets, Siren, Hegic, Friktion, Opyn Squeeth, Dopex, Premia, Shield, Pods, Deri, etc. Unlike base primitives, these protocols are directly exposed to market risk. Therefore, when it comes to collateral, in almost all such protocols we see some risk-aversion measures involved to hedge the flow and LP assets.
In Arrow markets, the collateral (primary pool) is hedged dynamically with an insurance component (insurance pool). Agents contributing to the liability of the pool are charged proportionately along with the aforementioned mechanism. It helps in controlling the cost of capital for the primary pool. Though the protocol hasn’t been deployed on main-net yet, theoretically this mechanism could hedge the risk to protocol’s liquidity pretty well. On the other hand, protocols like Siren avert risk to the system’s capital by providing structural flexibility to the components involved with the flow of collateral. Automated market maker (AMM) layer has been separated from the settlement layer along with a ‘diversification’ approach to LPs’ capital by distributing them among different markets.
Risk Stability Circuit of Arrow Markets Source: https://docs.arrow.markets/litepaper
Hegic, as described earlier, distributes the risk as well as gains among LPs. But as they are option writers, their capital accrue opportunity cost from being locked up. To compensate, hegic’s initial implementation allowed LPs to withdraw up to 20% of their capital from the liquidity pool anytime before expiration. But what happens when requested amount of capital isn’t available? Then they stand in a queue! Yeah literally, their requests are lined up in a queue, and are executed immediately whenever the liquidity is available. So, I don’t think this helps in making your protocol anymore efficient with its liquidity. Now, you know the reason behind a drastic fall in the TVL, right?
On the contrary, protocols like Friktion, Dopex and Deri avert risk to collateral in the system by restricting the in and out flow of the capital for a certain period of time. Apart from this feature, Dopex has laid an intelligent piece of infrastructure to manage and protect the collateral present in its system. LPs in Dopex act as ‘option writers’ where they retain the USD value of their capital if the asset price goes up, while their token value (for ex. ETH) is retained if the asset price goes down. It has single staking option vaults (SSOVs) where they (LPs) can deposit their collateral and earn a yield on it in the form of $DPX emissions, as well as the premium. If their collateral is lost (as a result of position expiring in-the-money), $rDPX emissions (equal to 25–30% of their loss) are released as a compensatory measure. In a recent update Dopex has introduced on-chain atlantic options to make the whole process more capital efficient. These are european-style options where the collateral deposited by the option-writer can be borrowed by a borrower for a funding-fee in exchange for an underlying token (ex. ETH) as a collateral. In this way, there is significant reduction in opportunity cost on writer’s collateral.
Similar mechanism of LPs being ‘option writers’ is followed by Siren and Hegic. Siren has a bilateral tokenization mechanism. Option writer mints two ERC-1155 tokens, buyer (b) and writer (w). They can then sell the b token to the option buyer for a premium. B token holder has the right to execute the contract at the strike price, while the writer with the w token earns a premium, as well as can withdraw the underlying after the expiration.
When we consider Opyn Squeeth (based on paradigm’s power perps), it attracts liquidity in the system by capping the downside for its derivative token. It allows users to long or short a special index like eth². Long squeeth (oSQTH) isn’t a leveraged position and hence by taking a long position it’s impossible to get liquidated. The only detrimental factor to your position is constant funding rates being paid by long-to-short squeethers. On the other hand you will definitely get liquidated if you are short squeeth (sSQU), though you can surely earn some funding by taking this risk!
A Comparison of Profit and Loss (PNL) Generated by ETH and Squeeth Positions Source: https://squeeth.opyn.co/

PRICING MECHANISMS
Option positions, minted by an isolated engine, are traded in a free-market. And hence there are a number of ways to decide their worth or price. One of them being the Black-Scholes (BS) also called the Black-Scholes-Merton model, which was found to be the most popular one in our review. This model tries to estimate the theoretical value of derivatives using five input variables — the strike price of an option, the current asset price (spot), the time to expiration, the risk-free rate, and the volatility. Standard BS model assumes that options could not be exercised before their expiration, and hence can only be used for european-style options.
Graphical Exploration of Black-Scholes-Merton Option Pricing Model Source: mathworks
If the research findings of the Potion Labs on BS are to be believed, then it poses significant risks to LPs. This model, given its underestimation of risk in highly-volatile markets like crypto was found to produce bankruptcy for major crypto assets. So, even though it’s considered the industry standard, there’s certainly no harm in keeping some caution.
Siren, Lyra, Dopex, Premia, Pods, Rysk and Auctus all use BS to price the options either directly or with some modifications. It is used with some modifications to price options at Siren, Lyra, Dopex, Premia and Rysk. Siren uses a mix of BS and the pricing mechanisms of Opyn (orderbook at 0xarbitrage), whereas Lyra takes a strike-adjusted implied volatility (IV) approach with BS to reach a theoretical price. Dopex prices options similarly to that of Lyra. And if we talk about Premia, it takes into account IV skew, position-size, pool capital supply and demand, along with the standard BS mechanism — making the whole process ‘liquidity sensitive’. Rysk on the other hand uses BS with an IV skew, portfolio delta and utilization.
Apart from this, protocols like Arrow Markets, Hegic and Deri price options according to different sensitivities. Arrow markets has a risk-sensitive approach to pricing. Along with some complex optimization, their pricing relies on risk assessment of AMM as well as on the chosen hedge by the engine. Their documents state:
It can be shown that this formulation sets prices in a way that is equivalent to the case where the market maker is optimizing a CARA utility function over future payouts.
Hegic on the other hand has a time-sensitive approach. Price of an option contract on Hegic depends on its intrinsic value as well as on amount of time until it expires. While pricing of options on Deri depends on the trade size optimized by volatility-sensitive mechanisms.
Opyn Squeeth though is based on an index, uses Uniswap V3 Pools. Ribbon probably has the most unique pricing mechanism compared to other option protocols. It sells the options (minted through Opyn by their theta vaults) using gnosis batch auctions. Here all the options are sold in only one clearing price. Figures below illustrate the intricacies involved in this process.
Gnosis Batch Auctions for Ribbon Finance: (A). Sequence of Events Involved in these Auctions (B). Price Discovery in Gnosis Batch Auctions Source: Ribbon Finance
In these auctions, bids are arranged from highest to lowest once all the bids are placed. They are sold in the same order (see fig above). Ribbon’s option sales is decentralized as the price discovery occurs on-chain. It might be a possibility that they soon shift to a silent-auction mechanism.

BUT WHAT ABOUT ADOPTION?
“Simplicity is the ultimate sophistication” — Leonardo Da Vinci. Though the nerds might get really fascinated with all the complexities involved in on-chain options, it’s not really good for their mass adoption. It’s really not a wise decision to ignore that corporate giants are paying millions of dollars everyday just for a moment of your attention.

Any product which requires a lot of sensory effort to use it, is simply not gonna make it! And hence, products which are easy to interact and use are going to win this game. This is probably one of the reasons why strategy vaults are getting popular with option protocols. Users can simply deposit their capital in these vaults and earn the advertised yield on it without worrying about any complex mathematical equations operating inside it.
So if we have to arrange these protocols in order of the ‘ease’ in which they can be used. Thetanuts, Dopex, Ribbon, Rysk, Jones DAO, PsyFinance, Katana, Friktion, Opyn Squeeth (Crab Strategy) would probably be the easiest as they provide their users with yield generating strategy vaults. While protocols like Siren, Opyn, Lyra and Pods could be classified somewhere in between as one can buy option-positions for a premium at a certain strike-price or tokens representing option positions (oTokens on Opyn) on them. Whereas protocols like Oddz, Auctus, Hegic and Premia are more suitable for professional traders. They provide users with variety of products which lets you generate customized positions.

WHAT LIES AHEAD?
In an ecosystem where wars have been brewing in on the back of derivatives (all thanks to DeFi’s composability), this doesn’t really end here. Options though chief vehicles of risk-hedging in boring traditional finance, are certainly a lot more than that in a highly-innovative decentralized finance. As crypto market gets bigger, derivatives are only going to grow from here. But surely not until the major challenges regarding efficiency and engineering of liquidity, accuracy of pricing, and information gap on derivatives are appropriately addressed. I would still remain very hopeful specially looking at innovative products from Rysk and Potion Labs. And in the end, no one really knows how many Heisenbergs are currently working on some byzantine derivatives operating from their underground labs 👀

Author is a Decentralized Finance (DeFi) researcher and analyst at Polygon with special emphasis on fundamentals, on-chain activity and social-media narratives. Their other interests include studying Attention Economy, Rumor Networks and Cognitive Design of Cryptocurrency Protocols. They like to do gardening, scroll twitter and explore different movie genres in their free time. They can be reached on twitter at 0xlol